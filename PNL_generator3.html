<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.T Commodities - PNL Report Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .card { @apply bg-white p-6 rounded-xl shadow-lg border border-gray-100; }
        .input-field { @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border; }
        .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out; }
        
        /* === Print Styles for A4 PDF Generation === */
        @media print {
            /* Hide UI elements not part of the report */
            .pnl-app > *:not(.report-container) {
                display: none !important;
            }
            .report-container {
                display: block !important;
                width: 210mm; /* A4 width */
                min-height: 297mm; /* A4 height */
                margin: 0 auto;
                padding: 10mm;
                box-shadow: none; /* Remove shadows for print */
                background: white;
            }
            /* Ensure tables and text are clearly visible */
            h1, h2, h3, h4, p, table { color: #000 !important; }
            table { font-size: 10pt; }
            .print-hidden { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Firebase Imports and Setup (Must be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, where, getDocs, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'at-commodities-pnl-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let pnlData = { purchases: [], sales: [], expenses: [] };
        let currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
        
        // State variables (managed by global object/functions for simplicity in non-React environment)
        const state = {
            isAuthReady: false,
            currentMonth: currentMonth,
            pnlData: { purchases: [], sales: [], expenses: [] },
            grossProfit: 0,
            totalExpenses: 0,
            netProfit: 0,
            newPurchase: {},
            newSale: {},
            newExpense: {},
        };

        const getPnlRef = (monthId) => {
            if (!userId) {
                console.error("User ID not available for Firestore.");
                return null;
            }
            // Private data storage path
            return doc(db, `artifacts/${appId}/users/${userId}/pnl_reports`, monthId);
        };

        const renderUI = () => {
            const container = document.getElementById('pnl-container');
            if (!container) return;
            
            // Render PNL Summary
            document.getElementById('gross-profit-display').textContent = formatCurrency(state.grossProfit);
            document.getElementById('total-expenses-display').textContent = formatCurrency(state.totalExpenses);
            document.getElementById('net-profit-display').textContent = formatCurrency(state.netProfit);
            
            const netProfitClass = state.netProfit >= 0 ? 'text-green-600' : 'text-red-600';
            document.getElementById('net-profit-display').className = `${netProfitClass} font-bold text-3xl`;

            // Render Purchases Table
            renderTable('purchases-table', state.pnlData.purchases, ['Date', 'Vehicle', 'Supplier', 'Quantity (MT)', 'Price/Ton', 'Cost']);
            
            // Render Sales Table
            renderTable('sales-table', state.pnlData.sales, ['Date', 'Vehicle', 'Customer', 'Quantity (MT)', 'Price/Ton', 'Revenue']);
            
            // Render Expenses Table
            renderTable('expenses-table', state.pnlData.expenses, ['Voucher No.', 'Date', 'Narration', 'Amount']);

            // Update Month Display for Report
            document.getElementById('report-month-display').textContent = state.currentMonth;
        };

        const renderTable = (tableId, data, headers) => {
            const tableBody = document.getElementById(tableId);
            if (!tableBody) return;

            // Update Total Header
            if (tableId === 'purchases-table') {
                const totalCost = data.reduce((sum, item) => sum + item.cost, 0);
                document.getElementById('purchases-total-header').textContent = `Total Purchase Cost: ${formatCurrency(totalCost)}`;
            } else if (tableId === 'sales-table') {
                const totalRevenue = data.reduce((sum, item) => sum + item.revenue, 0);
                document.getElementById('sales-total-header').textContent = `Total Sales Revenue: ${formatCurrency(totalRevenue)}`;
            } else if (tableId === 'expenses-table') {
                const totalExpenseAmount = data.reduce((sum, item) => sum + item.amount, 0);
                document.getElementById('expenses-total-header').textContent = `Total Monthly Expenses: ${formatCurrency(totalExpenseAmount)}`;
            }


            // Render Table Body
            tableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50';
                
                let cells = [];
                if (tableId === 'purchases-table') {
                    cells = [item.date, item.vehicle, item.supplier, item.quantity, formatCurrency(item.pricePerTon), formatCurrency(item.cost)];
                } else if (tableId === 'sales-table') {
                    cells = [item.date, item.vehicle, item.customer, item.quantity, formatCurrency(item.pricePerTon), formatCurrency(item.revenue)];
                } else if (tableId === 'expenses-table') {
                    cells = [item.voucher, item.date, item.narration, formatCurrency(item.amount)];
                }
                
                cells.forEach(cellText => {
                    const td = document.createElement('td');
                    td.className = 'p-3 text-sm';
                    td.textContent = cellText;
                    row.appendChild(td);
                });

                // Delete Button
                const deleteTd = document.createElement('td');
                deleteTd.className = 'p-3 text-right';
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'x';
                deleteBtn.className = 'text-red-500 hover:text-red-700 font-bold';
                deleteBtn.onclick = () => deleteTransaction(tableId.split('-')[0], index);
                deleteTd.appendChild(deleteBtn);
                row.appendChild(deleteTd);

                tableBody.appendChild(row);
            });
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount);
        };

        const calculatePNL = (data) => {
            const totalPurchaseCost = data.purchases.reduce((sum, p) => sum + p.cost, 0);
            const totalSalesRevenue = data.sales.reduce((sum, s) => sum + s.revenue, 0);
            const totalExpenses = data.expenses.reduce((sum, e) => sum + e.amount, 0);

            const grossProfit = totalSalesRevenue - totalPurchaseCost;
            const netProfit = grossProfit - totalExpenses;
            
            state.grossProfit = grossProfit;
            state.totalExpenses = totalExpenses;
            state.netProfit = netProfit;
            
            renderUI();
        };

        // --- Core Data Operations ---

        const setupDataListener = (monthId) => {
            if (!state.isAuthReady || !db) return;

            const pnlRef = getPnlRef(monthId);
            if (!pnlRef) return;

            // Listen for real-time changes
            onSnapshot(pnlRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Data loaded successfully
                    const data = docSnap.data();
                    state.pnlData = {
                        purchases: data.purchases || [],
                        sales: data.sales || [],
                        expenses: data.expenses || [],
                    };
                    console.log(`Data loaded for ${monthId}`);
                } else {
                    // Document doesn't exist, initialize with empty data
                    state.pnlData = { purchases: [], sales: [], expenses: [] };
                    console.log(`No data for ${monthId}, initializing empty report.`);
                }
                // Always recalculate and re-render after loading/initialization
                calculatePNL(state.pnlData);
            }, (error) => {
                console.error("Error setting up snapshot listener:", error);
            });
        };

        const saveData = async () => {
            if (!db || !userId) return;
            try {
                const pnlRef = getPnlRef(state.currentMonth);
                // Ensure all complex fields are initialized as arrays
                const dataToSave = {
                    purchases: state.pnlData.purchases || [],
                    sales: state.pnlData.sales || [],
                    expenses: state.pnlData.expenses || [],
                    monthId: state.currentMonth,
                    lastUpdated: new Date().toISOString()
                };
                
                await setDoc(pnlRef, dataToSave, { merge: false });
                console.log(`PNL data saved successfully for ${state.currentMonth}!`);
                return true;
            } catch (error) {
                console.error("Error saving document: ", error);
                return false;
            }
        };
        
        // --- Transaction Management ---

        window.addTransaction = (type) => {
            let form;
            let newItem = {};
            let isItemValid = true;

            if (type === 'purchase') {
                form = document.getElementById('purchase-form');
                const qty = parseFloat(form.quantity.value);
                const price = parseFloat(form.pricePerTon.value);
                newItem = {
                    id: crypto.randomUUID(),
                    date: form.date.value,
                    vehicle: form.vehicle.value,
                    supplier: form.supplier.value,
                    quantity: qty,
                    pricePerTon: price,
                    cost: qty * price
                };
                if (!newItem.date || !newItem.vehicle || !newItem.supplier || isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) isItemValid = false;
                if (isItemValid) state.pnlData.purchases.push(newItem);
            } else if (type === 'sale') {
                form = document.getElementById('sale-form');
                const qty = parseFloat(form.quantity.value);
                const price = parseFloat(form.pricePerTon.value);
                newItem = {
                    id: crypto.randomUUID(),
                    date: form.date.value,
                    vehicle: form.vehicle.value,
                    customer: form.customer.value,
                    quantity: qty,
                    pricePerTon: price,
                    revenue: qty * price
                };
                if (!newItem.date || !newItem.vehicle || !newItem.customer || isNaN(qty) || isNaN(price) || qty <= 0 || price <= 0) isItemValid = false;
                if (isItemValid) state.pnlData.sales.push(newItem);
            } else if (type === 'expense') {
                form = document.getElementById('expense-form');
                const amount = parseFloat(form.amount.value);
                newItem = {
                    id: crypto.randomUUID(),
                    voucher: form.voucher.value,
                    date: form.date.value,
                    narration: form.narration.value,
                    amount: amount
                };
                if (!newItem.voucher || !newItem.date || !newItem.narration || isNaN(amount) || amount <= 0) isItemValid = false;
                if (isItemValid) state.pnlData.expenses.push(newItem);
            }
            
            if (isItemValid) {
                form.reset();
                calculatePNL(state.pnlData);
                saveData();
            } else {
                console.warn('Invalid input for transaction.');
                alert('Please ensure all fields are filled correctly with positive numbers for quantity/price/amount.');
            }
        };

        const deleteTransaction = (type, index) => {
            if (type === 'purchase') {
                state.pnlData.purchases.splice(index, 1);
            } else if (type === 'sale') {
                state.pnlData.sales.splice(index, 1);
            } else if (type === 'expense') {
                state.pnlData.expenses.splice(index, 1);
            }
            calculatePNL(state.pnlData);
            saveData();
        };

        // --- Month Selection Handler ---
        window.handleMonthChange = (event) => {
            const newMonth = event.target.value;
            if (newMonth !== state.currentMonth) {
                state.currentMonth = newMonth;
                // Re-establish listener for the new month
                setupDataListener(newMonth); 
            }
        };

        // --- Firebase Initialization ---
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. App will run without persistence.");
                    document.getElementById('loading-state').textContent = "Firebase configuration is missing. Running in non-persistent demo mode.";
                    state.isAuthReady = true;
                    // Trigger initial UI render for demo mode
                    calculatePNL(state.pnlData);
                    return; 
                }
                
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Handle Auth State
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    } else {
                        // Sign in anonymously if no token, otherwise use the token
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (e) {
                                console.error("Error signing in with custom token, signing in anonymously.", e);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    if (!state.isAuthReady) {
                        state.isAuthReady = true;
                        // Use current month when app loads
                        setupDataListener(state.currentMonth); 
                    }
                    unsubscribe(); // Stop listening after initial auth
                });

            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                document.getElementById('loading-state').textContent = "Failed to load Firebase services. Running in non-persistent demo mode.";
                state.isAuthReady = true;
                calculatePNL(state.pnlData);
            }
        };

        // --- PDF Generation Function ---
        window.generatePDFReport = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, mm, A4

            const reportElement = document.getElementById('report-container-pdf');
            const fileName = `PNL_Report_${state.currentMonth}_ATC.pdf`;

            // Use html2canvas to render the entire report container
            html2canvas(reportElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // Add image to PDF
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Handle multi-page content (though we aim for single page)
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(fileName);
                console.log(`PDF generated: ${fileName}`);
            });
        };

        // Initialize on load
        window.onload = () => {
            initializeFirebase();
            
            // Set up initial month selector value
            const monthInput = document.getElementById('month-selector');
            monthInput.value = state.currentMonth;
            
            // Populate future months if needed for demo
            const today = new Date();
            for (let i = 0; i < 6; i++) { // Add 6 future months
                const nextMonth = new Date(today.getFullYear(), today.getMonth() + i + 1, 1);
                const value = nextMonth.toISOString().substring(0, 7);
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                monthInput.appendChild(option);
            }

            // Also render initial empty state
            renderUI();
        };

    </script>
    
    <div class="pnl-app max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">A.T Commodities - Monthly P&L Report</h1>
            <p class="mt-2 text-lg text-indigo-600">Coal & Minerals Trading Co.</p>
        </header>

        <!-- Loading/Auth Status -->
        <div id="loading-state" class="text-center text-sm mb-4 text-gray-500">
            <span id="user-id-display" class="font-mono text-xs">Initializing Firebase...</span>
        </div>
        
        <!-- Controls and Summary -->
        <div class="card mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
            
            <!-- Month Selector -->
            <div>
                <label for="month-selector" class="block text-sm font-medium text-gray-700">Select Reporting Month</label>
                <input type="month" id="month-selector" onchange="handleMonthChange(event)" class="input-field max-w-[150px]">
            </div>

            <!-- Gross Profit -->
            <div class="text-center">
                <p class="text-lg font-medium text-gray-500">Gross Profit</p>
                <p id="gross-profit-display" class="text-indigo-600 font-bold text-3xl">-</p>
            </div>

            <!-- Total Expenses -->
            <div class="text-center">
                <p class="text-lg font-medium text-gray-500">Total Expenses</p>
                <p id="total-expenses-display" class="text-red-600 font-bold text-3xl">-</p>
            </div>

            <!-- Net Profit -->
            <div class="text-center">
                <p class="text-lg font-medium text-gray-500">Net Profit</p>
                <p id="net-profit-display" class="text-gray-900 font-bold text-3xl">-</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 mb-8 print-hidden">
            <button onclick="generatePDFReport()" class="btn-primary flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                Download PDF Report
            </button>
        </div>


        <!-- Data Entry & Report Sections (Grid Layout) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12 print-hidden">
            
            <!-- 1. Monthly Purchases Tracker -->
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Monthly Purchases Tracker</h2>
                <div class="card">
                    <form id="purchase-form" onsubmit="event.preventDefault(); addTransaction('purchase');" class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                        <input type="date" name="date" placeholder="Date" class="input-field" required>
                        <input type="text" name="vehicle" placeholder="Vehicle No." class="input-field" required>
                        <input type="text" name="supplier" placeholder="Supplier Name" class="input-field" required>
                        <input type="number" name="quantity" placeholder="Quantity (MT)" step="0.01" min="0.01" class="input-field" required>
                        <input type="number" name="pricePerTon" placeholder="Price/Ton" step="0.01" min="0.01" class="input-field" required>
                        <button type="submit" class="btn-primary sm:col-span-5 mt-2">Add Purchase</button>
                    </form>
                </div>
            </div>

            <!-- 2. Monthly Sales Tracker -->
            <div class="lg:col-span-1">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">2. Monthly Sales Tracker</h2>
                <div class="card">
                    <form id="sale-form" onsubmit="event.preventDefault(); addTransaction('sale');" class="grid grid-cols-2 gap-4">
                        <input type="date" name="date" placeholder="Date" class="input-field" required>
                        <input type="text" name="vehicle" placeholder="Vehicle No." class="input-field" required>
                        <input type="text" name="customer" placeholder="Customer Name" class="input-field col-span-2" required>
                        <input type="number" name="quantity" placeholder="Quantity (MT)" step="0.01" min="0.01" class="input-field" required>
                        <input type="number" name="pricePerTon" placeholder="Price/Ton" step="0.01" min="0.01" class="input-field" required>
                        <button type="submit" class="btn-primary col-span-2 mt-2">Add Sale</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- 4. Monthly Expenses Manager -->
        <div class="mb-12 print-hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">4. Monthly Expenses Manager</h2>
            <div class="card">
                <form id="expense-form" onsubmit="event.preventDefault(); addTransaction('expense');" class="grid grid-cols-1 sm:grid-cols-6 gap-4">
                    <input type="text" name="voucher" placeholder="Voucher No." class="input-field" required>
                    <input type="date" name="date" placeholder="Date" class="input-field" required>
                    <input type="text" name="narration" placeholder="Narration (e.g., Office Rent, Fuel)" class="input-field sm:col-span-2" required>
                    <input type="number" name="amount" placeholder="Amount (INR)" step="0.01" min="0.01" class="input-field" required>
                    <button type="submit" class="btn-primary sm:col-span-1 mt-2">Add Expense</button>
                </form>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- REPORT DISPLAY AREA (Will be used for PDF/Print) -->
        <!-- ============================================== -->
        <div id="report-container-pdf" class="report-container w-full bg-white p-6 shadow-xl rounded-xl">
            <h1 class="text-3xl font-bold text-center mb-1 text-gray-800">Profit & Loss Statement</h1>
            <h2 class="text-xl font-medium text-center text-indigo-600 mb-4">A.T Commodities - Report for <span id="report-month-display"></span></h2>
            
            <!-- 5. Net Profit Summary Section (Top of Report) -->
            <div class="grid grid-cols-3 gap-4 mb-8 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="text-center">
                    <p class="text-sm font-medium text-gray-500">Gross Profit</p>
                    <p id="gross-profit-display-report" class="text-indigo-700 font-extrabold text-2xl" data-bind="gross-profit-display"></p>
                </div>
                <div class="text-center">
                    <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                    <p id="total-expenses-display-report" class="text-red-700 font-extrabold text-2xl" data-bind="total-expenses-display"></p>
                </div>
                <div class="text-center">
                    <p class="text-sm font-medium text-gray-500">NET PROFIT / LOSS</p>
                    <p id="net-profit-display-report" class="font-extrabold text-3xl" data-bind="net-profit-display"></p>
                </div>
            </div>

            <!-- Detailed Tables -->
            
            <!-- Purchases Summary -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-3 border-b pb-1 text-gray-700">1 & 3. Purchase Cost & Gross Profit Calculation</h3>
                <h4 id="purchases-total-header" class="text-lg font-medium text-gray-600 mb-2">Total Purchase Cost: -</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Vehicle No.</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Supplier Name</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Quantity (MT)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Price/Ton</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Total Cost</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider print-hidden">Del</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-table" class="bg-white divide-y divide-gray-200">
                            <!-- Purchase rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sales Summary -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-3 border-b pb-1 text-gray-700">2. Sales Revenue</h3>
                <h4 id="sales-total-header" class="text-lg font-medium text-gray-600 mb-2">Total Sales Revenue: -</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Vehicle No.</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Customer Name</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Quantity (MT)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Price/Ton</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Total Revenue</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider print-hidden">Del</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table" class="bg-white divide-y divide-gray-200">
                            <!-- Sale rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Expenses Summary -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-3 border-b pb-1 text-gray-700">4. Monthly Operating Expenses</h3>
                <h4 id="expenses-total-header" class="text-lg font-medium text-gray-600 mb-2">Total Monthly Expenses: -</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Voucher No.</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Voucher Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Narration</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider">Amount (INR)</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider print-hidden">Del</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table" class="bg-white divide-y divide-gray-200">
                            <!-- Expense rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <p class="text-center text-xs text-gray-500 mt-10">Report Generated by A.T Commodities PNL System - Data stored securely via Firebase Firestore.</p>

        </div>

        <p class="text-center text-xs text-gray-400 mt-4 print-hidden">Note: All data is saved automatically and linked to the selected month via Firebase Firestore.</p>

    </div>

    <!-- Script to copy data between the main UI and the hidden PDF report container -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Function to synchronize PNL totals for PDF report
            const observer = new MutationObserver((mutationsList, observer) => {
                for(const mutation of mutationsList) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        // Select all elements in the report container that have a data-bind attribute
                        const reportElements = document.querySelectorAll('#report-container-pdf [data-bind]');
                        reportElements.forEach(reportEl => {
                            const sourceId = reportEl.getAttribute('data-bind');
                            const sourceEl = document.getElementById(sourceId);
                            if (sourceEl) {
                                reportEl.textContent = sourceEl.textContent;
                                reportEl.className = sourceEl.className.replace('text-3xl', 'text-2xl'); // Adjust size for report
                                if (sourceId === 'net-profit-display') {
                                    reportEl.className = sourceEl.className.replace('text-3xl', 'text-3xl');
                                }
                            }
                        });
                    }
                }
            });

            // Start observing the summary card for changes in data displays
            const targetNode = document.querySelector('.pnl-app > .card:nth-child(3)'); // The PNL Summary card
            if (targetNode) {
                observer.observe(targetNode, { childList: true, subtree: true, characterData: true });
            }
        });
    </script>
</body>
</html>
